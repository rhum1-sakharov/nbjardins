<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

    <changeSet id="202103062041-1" author="rvl">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="artisans_options"></tableExists>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE `artisans_options` (
            `ID` VARCHAR(36) NOT NULL DEFAULT '',
            `ID_ARTISAN` VARCHAR(36) NOT NULL DEFAULT '',
            `MODELE_OPTION` ENUM('TVA_SAISISSABLE_PAR_LIGNE','COLONNE_QUANTITE','COORDONNEES_BANQUAIRES') NOT NULL,
            `ACTIF` TINYINT(1) NOT NULL DEFAULT '0',
            PRIMARY KEY (`ID`),
            UNIQUE INDEX `unique_artisan_option` (`ID_ARTISAN`, `MODELE_OPTION`),
            CONSTRAINT `FK__ao__artisans` FOREIGN KEY (`ID_ARTISAN`) REFERENCES `artisans` (`ID`) ON UPDATE CASCADE ON
            DELETE CASCADE
            )
            COLLATE='utf8_general_ci'
            ;
        </sql>
        <comment>
            Ajout de la table artisans_options
        </comment>
    </changeSet>

    <changeSet id="202103062109-1" author="rvl">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="artisans_options"></tableExists>
        </preConditions>
        <sql>
            set @rownum := 0;
            INSERT INTO artisans_options (id, id_artisan, MODELE_OPTION, actif )
            SELECT @rownum := @rownum + 1, a.ID, 'TVA_SAISISSABLE_PAR_LIGNE',0 FROM artisans a;
            INSERT INTO artisans_options (id, id_artisan, MODELE_OPTION, actif )
            SELECT @rownum := @rownum + 1, a.ID, 'COLONNE_QUANTITE',0 FROM artisans a;
            INSERT INTO artisans_options (id, id_artisan, MODELE_OPTION, actif )
            SELECT @rownum := @rownum + 1, a.ID, 'COORDONNEES_BANQUAIRES',0 FROM artisans a;
        </sql>
        <comment>
            Ajout des options par défaut pour les artisans déjà présents
        </comment>
    </changeSet>

    <changeSet id="202103071836" author="rvl">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="artisans_banques" columnName="BANQUE"></columnExists>
            </not>
        </preConditions>
        <sql>
            ALTER TABLE `artisans_banques`
            ADD COLUMN `BANQUE` VARCHAR(50) NOT NULL AFTER `RIB`;
        </sql>
        <comment>
          Ajout de la colonne banque sur artisans_banques
        </comment>
    </changeSet>

    <changeSet id="202103141442" author="rvl">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="artisans" columnName="EMAIL_PRO"></columnExists>
            </not>
        </preConditions>
        <sql>
            ALTER TABLE `artisans`
            ADD COLUMN `EMAIL_PRO` VARCHAR(50) NOT NULL AFTER `ID_CONDITION_DE_REGLEMENT`;

        </sql>
        <comment>
            Ajout de la colonne email_pro sur artisans
        </comment>
    </changeSet>

    <changeSet id="202103172127" author="rvl">
        <preConditions onFail="MARK_RAN">
                <columnExists tableName="devis" columnName="STATUT"></columnExists>
        </preConditions>
        <sql>
           delete from devis;
            ALTER TABLE `devis`
            CHANGE COLUMN `STATUT` `STATUT` ENUM('A_TRAITER','TRAITE','ACCEPTE','REFUSE','ABANDON') NOT NULL COLLATE 'utf8_general_ci' AFTER `MESSAGE`;

        </sql>
        <comment>
            modification des statuts d'un devis
        </comment>
    </changeSet>

    <changeSet id="202104022044" author="rvl">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="devis_options"></tableExists>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE `devis_options` (
            `ID` VARCHAR(36) NOT NULL,
            `ID_DEVIS` VARCHAR(36) NOT NULL,
            `MODELE_OPTION` ENUM('TVA_SAISISSABLE_PAR_LIGNE','COLONNE_QUANTITE','COORDONNEES_BANQUAIRES') NOT NULL ,
            `ACTIF` TINYINT NOT NULL DEFAULT 0,
            PRIMARY KEY (`ID`),
            INDEX `ID_DEVIS` (`ID_DEVIS`),
            UNIQUE INDEX `unique_devis_modele_option` (`ID_DEVIS`, `MODELE_OPTION`),
            CONSTRAINT `FK__do_devis` FOREIGN KEY (`ID_DEVIS`) REFERENCES `devis` (`ID`) ON UPDATE CASCADE ON DELETE CASCADE
            )
            COLLATE='utf8_general_ci'
            ;

        </sql>
        <comment>
          ajout de la table devis options
        </comment>
    </changeSet>

    <changeSet id="202104022057" author="rvl">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="clients" columnName="SIRET"></columnExists>
                <columnExists tableName="clients" columnName="SIGNATURE"></columnExists>
                <columnExists tableName="clients" columnName="ID_ARTISAN"></columnExists>
            </not>
        </preConditions>
        <sql>
            ALTER TABLE `clients`
            ADD COLUMN `ID_ARTISAN` VARCHAR(50) NOT NULL AFTER `ID`,
            ADD COLUMN `SIRET` VARCHAR(50) NULL DEFAULT NULL AFTER `ID_PERSONNE`,
            ADD COLUMN `SIGNATURE` VARCHAR(256) NULL DEFAULT NULL AFTER `SIRET`,
            ADD INDEX `ID_ARTISAN` (`ID_ARTISAN`),
            ADD CONSTRAINT `FK_clients_artisans` FOREIGN KEY (`ID_ARTISAN`) REFERENCES `artisans` (`ID`) ON UPDATE CASCADE ON DELETE CASCADE;


        </sql>
        <comment>
            ajout des colonnes siret, signature, id_artisan dans la table clients
        </comment>
    </changeSet>

    <changeSet id="202104022103" author="rvl">
        <preConditions onFail="MARK_RAN">
            <indexExists tableName="clients" indexName="clients_ID_PERSONNE_uindex"></indexExists>
            <not>
                <indexExists tableName="clients" indexName="unique_artisan_personne"></indexExists>
            </not>
        </preConditions>
        <sql>
            ALTER TABLE `clients`
            DROP INDEX `clients_ID_PERSONNE_uindex`,
            ADD UNIQUE INDEX `unique_artisan_personne` (`ID_PERSONNE`, `ID_ARTISAN`);
        </sql>
        <comment>
            ajout de l'unicité [id_personne / id_artisan] dans la table clients
        </comment>
    </changeSet>

    <changeSet id="202104022129" author="rvl">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="devis"></tableExists>
        </preConditions>
        <sql>
            drop TABLE `devis`;
        </sql>
        <comment>
            supprimer la table devis
        </comment>
    </changeSet>


</databaseChangeLog>
