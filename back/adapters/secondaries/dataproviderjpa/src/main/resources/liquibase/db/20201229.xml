<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

    <changeSet id="202012291656" author="rvl">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="devis" columnName="LIEU"></columnExists>
                <columnExists tableName="devis" columnName="LOGO"></columnExists>
                <columnExists tableName="devis" columnName="PROVISION"></columnExists>
                <columnExists tableName="devis" columnName="SIGNATURE"></columnExists>
            </not>
        </preConditions>
        <sql>
            ALTER TABLE devis ADD LIEU varchar(50) NOT NULL;
            ALTER TABLE devis ADD LOGO varchar(50) NOT NULL;
            ALTER TABLE devis ADD SIGNATURE VARCHAR(50) NOT NULL;
            ALTER TABLE devis ADD PROVISION DECIMAL(10,4) NOT NULL;
            ALTER TABLE devis MODIFY CONDITION_DE_REGLEMENT varchar(50) NOT NULL;
        </sql>
        <comment>
            Ajout des colonnes lieu, logo, provision, signature dans la table devis
        </comment>
    </changeSet>

    <changeSet id="202012291717" author="rvl">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="artisans" columnName="LOGO"></columnExists>
                <columnExists tableName="artisans" columnName="PROVISION"></columnExists>
                <columnExists tableName="artisans" columnName="SIGNATURE"></columnExists>
            </not>
        </preConditions>
        <sql>
            ALTER TABLE artisans ADD LOGO varchar(50) NOT NULL;
            ALTER TABLE artisans ADD SIGNATURE VARCHAR(50) NOT NULL;
            ALTER TABLE artisans ADD PROVISION DECIMAL(10,4) NOT NULL COMMENT 'en pourcent';
        </sql>
        <comment>
            Ajout des colonnes logo, provision, signature dans la table artisans
        </comment>
    </changeSet>

    <changeSet id="202012311037" author="rvl" runAlways="false">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="artisans" columnName="SITE"></columnExists>
            </not>
        </preConditions>
        <sql>
            ALTER TABLE artisans ADD SITE VARCHAR(50) NULL;
        </sql>
        <comment>
            Ajouter le site de l'artisan
        </comment>
    </changeSet>


    <changeSet id="202012311117" author="rvl">
        <preConditions onFail="MARK_RAN">
            <foreignKeyConstraintExists foreignKeyTableName="devis"
                                        foreignKeyName="fk__dd__askerpersonne"></foreignKeyConstraintExists>
            <foreignKeyConstraintExists foreignKeyTableName="devis"
                                        foreignKeyName="fk__dd__workerpersonne"></foreignKeyConstraintExists>
        </preConditions>
        <sql>
            ALTER TABLE `devis`
            DROP INDEX `fk__dd__askerpersonne`,
            DROP INDEX `fk__dd__workerpersonne`,
            DROP FOREIGN KEY `fk__dd__workerpersonne`,
            DROP FOREIGN KEY `fk__dd__askerpersonne`,
            DROP COLUMN `ID_ASKER`,
            DROP COLUMN `ID_WORKER`;
        </sql>
        <comment>
            Suppression de fk__dd__askerpersonne et fk__dd__workerpersonne dans devis
        </comment>
    </changeSet>

    <changeSet id="202012311121" author="rvl">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="devis" columnName="ID_WORKER"></columnExists>
                <columnExists tableName="devis" columnName="ID_ASKER"></columnExists>
            </not>
        </preConditions>
        <sql>
            ALTER TABLE `devis`
            ADD COLUMN `ID_ASKER` VARCHAR(36) NOT NULL AFTER `ID`,
            ADD COLUMN `ID_WORKER` VARCHAR(36) NOT NULL AFTER `ID_ASKER`,
            ADD INDEX `ID_WORKER` (`ID_WORKER`),
            ADD INDEX `ID_ASKER` (`ID_ASKER`),
            ADD CONSTRAINT `FK_devis_clients` FOREIGN KEY (`ID_ASKER`) REFERENCES `clients` (`ID`) ON UPDATE CASCADE,
            ADD CONSTRAINT `FK_devis_artisans` FOREIGN KEY (`ID_WORKER`) REFERENCES `artisans` (`ID`) ON UPDATE CASCADE;

        </sql>
        <comment>
            Recreation des colonnes ID_WORKER et ID_ASKER dans devis
        </comment>
    </changeSet>

    <changeSet id="202012311356" author="rvl">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="applications" columnName="ID_WORKER"></columnExists>
        </preConditions>
        <sql>
            set foreign_key_checks=0;
            ALTER TABLE `applications`
            ADD COLUMN `ID_ARTISAN` VARCHAR(36) NOT NULL AFTER `ID`,
            DROP COLUMN `ID_WORKER`,
            DROP INDEX `ID_WORKER`,
            DROP INDEX `unique_ID_WORKER_idx`,
            ADD INDEX `ID_ARTISAN` (`ID_ARTISAN`),
            ADD UNIQUE INDEX `unique_artisan_idx` (`ID_ARTISAN`),
            DROP FOREIGN KEY `FK__applications__personnes`,
            ADD CONSTRAINT `FK_applications_artisans` FOREIGN KEY (`ID_ARTISAN`) REFERENCES `artisans` (`ID`) ON UPDATE
            CASCADE ON DELETE CASCADE;
            set foreign_key_checks=1;

        </sql>
        <comment>
            renommer la colonne ID_wORKER en ID_ARTISAN dans la table applications
        </comment>
    </changeSet>

    <changeSet id="202012311400" author="rvl">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="artisans" columnName="SITE"></columnExists>
        </preConditions>
        <sql>
            ALTER TABLE `artisans`
            DROP COLUMN `SITE`;
        </sql>
        <comment>
            supprimer la colonne site de la table artisans
        </comment>
    </changeSet>

    <changeSet id="202012311645" author="rvl">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="applications" columnName="SITE"></columnExists>
            </not>
        </preConditions>
        <sql>
            ALTER TABLE `applications`
            ADD COLUMN `SITE` VARCHAR(50) NULL AFTER `TOKEN`;
        </sql>
        <comment>
            ajouter la colonne site dans la table applications
        </comment>
    </changeSet>

    <changeSet id="202101021356" author="rvl">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="artisans" columnName="SIRET"></columnExists>
            </not>
        </preConditions>
        <sql>
            ALTER TABLE artisans ADD SIRET VARCHAR(50) NOT NULL;
        </sql>
        <comment>
            ajouter la colonne siret dans la table artisans
        </comment>
    </changeSet>

    <changeSet id="202101021416" author="rvl">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="artisans" columnName="VALIDITE_DEVIS_MOIS"></columnExists>
            </not>
        </preConditions>
        <sql>
            ALTER TABLE artisans ADD VALIDITE_DEVIS_MOIS INT(2) NOT NULL;
        </sql>
        <comment>
            ajouter la duree de validite d'un devis pour un artisan
        </comment>
    </changeSet>

    <changeSet id="202101021420" author="rvl">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="devis" columnName="VALIDITE_DEVIS_MOIS"></columnExists>
            </not>
        </preConditions>
        <sql>
            ALTER TABLE devis ADD VALIDITE_DEVIS_MOIS INT(2) NOT NULL;
        </sql>
        <comment>
            ajouter la duree de validite d'un devis pour un devis
        </comment>
    </changeSet>

    <changeSet id="202101021359" author="rvl">
        <preConditions onFail="MARK_RAN">
                <columnExists tableName="artisans" columnName="PROVISION"></columnExists>
        </preConditions>
        <sql>
            ALTER TABLE `artisans`
            CHANGE COLUMN `PROVISION` `PROVISION` DECIMAL(10,4) NOT NULL COMMENT 'en euros' AFTER `SIGNATURE`;

        </sql>
        <comment>
            la colonne provision est exprimée en euros
        </comment>
    </changeSet>

    <changeSet id="202012241455" author="rvl" runAlways="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from artisans where
                ID_PERSONNE='08747d89-0c85-492b-b71a-cb6d244a9a00'
            </sqlCheck>
        </preConditions>
        <sql>
            INSERT INTO `artisans` (`ID`, `ID_PERSONNE`,`ID_TAXE`, `ID_CONDITION_DE_REGLEMENT`, `LOGO`, `SIGNATURE`,
            `PROVISION`, `SIRET`, `VALIDITE_DEVIS_MOIS`) VALUES
            ('0afc2070-9dc4-46e0-9660-36f09b72b237','08747d89-0c85-492b-b71a-cb6d244a9a00','2dc642a6-9396-4e51-a2b6-ff75a3330684','1','logo_nb_jardins.png','signature_nb_jardins.png',30,'80025030000011',2);
        </sql>
        <comment>
            Ajouter les artisans par defaut
        </comment>
    </changeSet>

    <changeSet id="202012232222" author="rvl" runAlways="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from artisans_banques where
                ID_ARTISAN='0afc2070-9dc4-46e0-9660-36f09b72b237' and iban='IBAN1' and rib='RIB1'
            </sqlCheck>
        </preConditions>
        <sql>
            INSERT INTO `artisans_banques` (`ID`, `ID_ARTISAN`, `IBAN`, `RIB`, `PREFERE`) VALUES
            ('dafaaf78-bbaa-4bc4-bb46-455e9cb5025c', '0afc2070-9dc4-46e0-9660-36f09b72b237', 'IBAN1', 'RIB1', 1);
        </sql>
        <comment>
            Ajouter les artisans_banques par defaut
        </comment>
    </changeSet>


    <changeSet id="202012190848" author="rvl">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from applications where
                ID_ARTISAN='0afc2070-9dc4-46e0-9660-36f09b72b237'
            </sqlCheck>
        </preConditions>
        <sql>
            INSERT INTO `applications` (`ID`, `ID_ARTISAN`,`NOM`,`TOKEN`,`SITE`) VALUES
            ('d60065ee-d018-4629-8794-25cd2eeb0187','0afc2070-9dc4-46e0-9660-36f09b72b237','Les jardins de
            Nicolas','NB_JARDINS','vps358243.ovh.net:81');
        </sql>
        <comment>
            Ajouter l'application de l'artisan nb
        </comment>
    </changeSet>

    <changeSet id="202101012057" author="rvl">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="devis" columnName="ID_WORKER"></columnExists>
            <columnExists tableName="devis" columnName="ID_ASKER"></columnExists>
        </preConditions>
        <sql>
            ALTER TABLE `devis`
            DROP FOREIGN KEY `FK_devis_artisans`,
            DROP FOREIGN KEY `FK_devis_clients`;
            ALTER TABLE `devis`
            CHANGE COLUMN `ID_ASKER` `ID_CLIENT` VARCHAR(36) NOT NULL COLLATE 'utf8_general_ci' AFTER `ID`,
            CHANGE COLUMN `ID_WORKER` `ID_ARTISAN` VARCHAR(36) NOT NULL COLLATE 'utf8_general_ci' AFTER `ID_CLIENT`,
            DROP INDEX `ID_WORKER`,
            ADD INDEX `ID_ARTISAN` (`ID_ARTISAN`) USING BTREE,
            DROP INDEX `ID_ASKER`,
            ADD INDEX `ID_CLIENT` (`ID_CLIENT`) USING BTREE,
            ADD CONSTRAINT `FK_devis_artisans` FOREIGN KEY (`ID_ARTISAN`) REFERENCES `artisans` (`ID`) ON UPDATE CASCADE ON DELETE CASCADE,
            ADD CONSTRAINT `FK_devis_clients` FOREIGN KEY (`ID_CLIENT`) REFERENCES `clients` (`ID`) ON UPDATE CASCADE ON DELETE CASCADE;

        </sql>
        <comment>
            renommer ID_WORKER en ID_ARTISAN dans la table devis
        </comment>
    </changeSet>

    <changeSet id="202101012123" author="rvl">
        <preConditions onFail="MARK_RAN">
          <not>
              <tableExists tableName="devis_lignes"></tableExists>
          </not>
        </preConditions>
        <sql>
            CREATE TABLE devis_lignes
            (
            ID VARCHAR(36) PRIMARY KEY NOT NULL,
            ID_DEVIS varchar(36) NOT NULL,
            DESIGNATION varchar(100) NOT NULL,
            MONTANT_HT DECIMAL(10,4) NOT NULL,
            CONSTRAINT devis_lignes_devis_ID_fk FOREIGN KEY (ID_DEVIS) REFERENCES devis (ID) ON DELETE CASCADE ON UPDATE CASCADE
            )
            COLLATE='utf8_general_ci'
            ;
            CREATE INDEX devis_lignes_ID_DEVIS_index ON devis_lignes (ID_DEVIS);
        </sql>
        <comment>
            Creer la table devis_lignes
        </comment>
    </changeSet>


    <changeSet id="202102232156" author="rvl" runAlways="true">
        <preConditions onFail="MARK_RAN">
           <columnExists tableName="artisans" columnName="LOGO"></columnExists>
        </preConditions>
        <sql>
            ALTER TABLE `artisans`
            CHANGE COLUMN `LOGO` `LOGO` VARCHAR(256) NOT NULL COLLATE 'utf8_general_ci' AFTER `ID_CONDITION_DE_REGLEMENT`;
        </sql>
        <comment>
            Changer la taille de logo à 256 varchar
        </comment>
    </changeSet>

    <changeSet id="202102242231-1" author="rvl" runAlways="true">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="personnes" columnName="TELEPHONE"></columnExists>
        </preConditions>
        <sql>
            ALTER TABLE `personnes`
            CHANGE COLUMN `TELEPHONE` `NUMERO_TELEPHONE` VARCHAR(10) NULL DEFAULT NULL COLLATE 'utf8_general_ci' AFTER `EMAIL`;

        </sql>
        <comment>
            Changer la colonne telephone en numeroTelephone
        </comment>
    </changeSet>

</databaseChangeLog>
