<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.4.xsd">

    <changeSet id="202012232237" author="rvl" >
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="devis" columnName="IBAN"></columnExists>
                <columnExists tableName="devis" columnName="RIB"></columnExists>
            </not>
        </preConditions>
        <sql>
            ALTER TABLE devis ADD IBAN varchar(50) NOT NULL;
            ALTER TABLE devis ADD RIB varchar(50) NOT NULL;
        </sql>
        <comment>
            Ajout des colonnes rib et iban dans la table devis
        </comment>
    </changeSet>

    <changeSet id="202012241430" author="rvl" >
        <preConditions onFail="MARK_RAN">
                <columnExists tableName="devis" columnName="DATE_CREATION"></columnExists>
        </preConditions>
        <sql>
            ALTER TABLE devis DROP DATE_CREATION;
        </sql>
        <comment>
            Suppression de la colonne date_creation dans la table devis
        </comment>
    </changeSet>

    <changeSet id="202012241432" author="rvl" >
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="devis" columnName="DATE_DEMANDE"></columnExists>
                <columnExists tableName="devis" columnName="DATE_ENVOYE"></columnExists>
                <columnExists tableName="devis" columnName="DATE_EN_COURS"></columnExists>
            </not>

        </preConditions>
        <sql>
            ALTER TABLE devis ADD DATE_DEMANDE date NULL;
            ALTER TABLE devis ADD DATE_EN_COURS date NULL;
            ALTER TABLE devis ADD DATE_ENVOYE date NULL;
        </sql>
        <comment>
           ajout des colonnes DATE_DEMANDE, DATE_ENVOYE, DATE_EN_COURS dans la table devis
        </comment>
    </changeSet>

    <changeSet id="202012241439" author="rvl" >
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="conditions_de_reglement" ></tableExists>
            </not>
        </preConditions>
        <sql>
            CREATE TABLE conditions_de_reglement
            (
            ID VARCHAR(36) PRIMARY KEY NOT NULL,
            LIBELLE varchar(50) NOT NULL
            )
            COLLATE='utf8_general_ci'
            ;
            CREATE UNIQUE INDEX conditions_de_reglement_LIBELLE_uindex ON conditions_de_reglement (LIBELLE);
        </sql>
        <comment>
            ajout de la table conditions de reglement
        </comment>
    </changeSet>

    <changeSet id="202012241440" author="rvl" >
        <preConditions onFail="MARK_RAN">
           <sqlCheck expectedResult="0">select count(*) from conditions_de_reglement</sqlCheck>
        </preConditions>
        <sql>
            INSERT INTO `conditions_de_reglement` (`ID`, `LIBELLE`) VALUES ('1','à réception de la facture');
            INSERT INTO `conditions_de_reglement` (`ID`, `LIBELLE`) VALUES ('2','Maximum 10 jours après la réception de la facture');
        </sql>
        <comment>
            ajout des conditions de reglement
        </comment>
    </changeSet>

    <changeSet id="202012241441" author="rvl" >
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="artisans" columnName="ID_CONDITION_DE_REGLEMENT" ></columnExists>
            </not>
        </preConditions>
        <sql>
            ALTER TABLE artisans ADD ID_CONDITION_DE_REGLEMENT VARCHAR(36) NOT NULL;
            CREATE INDEX artisans_ID_CONDITION_DE_REGLEMENT__index ON artisans (ID_CONDITION_DE_REGLEMENT);
            ALTER TABLE artisans
            ADD CONSTRAINT artisans_conditions_de_reglement_ID_fk
            FOREIGN KEY (ID_CONDITION_DE_REGLEMENT) REFERENCES conditions_de_reglement (ID) ON UPDATE CASCADE;
        </sql>
        <comment>
            ajout du modes de reglement par defaut pour un artisan
        </comment>
    </changeSet>

    <changeSet id="202012241455" author="rvl" runAlways="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from artisans where ID_PERSONNE='08747d89-0c85-492b-b71a-cb6d244a9a00'</sqlCheck>
        </preConditions>
        <sql>
            INSERT INTO `artisans` (`ID`, `ID_PERSONNE`,`ID_TAXE`, `ID_CONDITION_DE_REGLEMENT`) VALUES ('0afc2070-9dc4-46e0-9660-36f09b72b237','08747d89-0c85-492b-b71a-cb6d244a9a00','2dc642a6-9396-4e51-a2b6-ff75a3330684','1');
        </sql>
        <comment>
            Ajouter les artisans par defaut
        </comment>
    </changeSet>

    <changeSet id="202012232222" author="rvl" runAlways="true">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">select count(*) from artisans_banques where ID_ARTISAN='0afc2070-9dc4-46e0-9660-36f09b72b237' and iban='IBAN1' and rib='RIB1'</sqlCheck>
        </preConditions>
        <sql>
            INSERT INTO `artisans_banques` (`ID`, `ID_ARTISAN`, `IBAN`, `RIB`, `PREFERE`) VALUES ('dafaaf78-bbaa-4bc4-bb46-455e9cb5025c', '0afc2070-9dc4-46e0-9660-36f09b72b237', 'IBAN1', 'RIB1', 1);
        </sql>
        <comment>
            Ajouter les artisans_banques par defaut
        </comment>
    </changeSet>

    <changeSet id="202012241500" author="rvl">
        <preConditions onFail="MARK_RAN">
          <not>
              <columnExists tableName="devis" columnName="ID_CONDITION_DE_REGLEMENT"></columnExists>
          </not>
        </preConditions>
        <sql>
            ALTER TABLE devis ADD CONDITION_DE_REGLEMENT VARCHAR(36) NOT NULL;
        </sql>
        <comment>
          Ajout de la colonne condition de reglement dans devis
        </comment>
    </changeSet>

    <changeSet id="202012291630" author="rvl">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="devis" columnName="DATE_CREATION"></columnExists>
            </not>
        </preConditions>
        <sql>
            ALTER TABLE devis ADD DATE_CREATION date NOT NULL;
            ALTER TABLE devis
            MODIFY COLUMN DATE_CREATION date NOT NULL AFTER RIB;
        </sql>
        <comment>
            Ajout de la date de creation du devis
        </comment>
    </changeSet>


</databaseChangeLog>
